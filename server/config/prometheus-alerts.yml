groups:
  - name: license_management
    interval: 1m
    rules:
      # License Validation Alerts
      - alert: HighLicenseValidationFailureRate
        expr: |
          (
            rate(license_validation_total{result="failure"}[5m]) 
            / 
            rate(license_validation_total[5m])
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          component: license_validation
        annotations:
          summary: "High license validation failure rate"
          description: "License validation failure rate is {{ $value | humanizePercentage }} for {{ $labels.module_key }}"

      - alert: LicenseValidationSystemDown
        expr: |
          rate(license_validation_total[5m]) == 0
        for: 5m
        labels:
          severity: critical
          component: license_validation
        annotations:
          summary: "License validation system appears to be down"
          description: "No license validation attempts detected in the last 5 minutes"

      - alert: SlowLicenseValidation
        expr: |
          histogram_quantile(0.95, rate(license_validation_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
          component: license_validation
        annotations:
          summary: "License validation is slow"
          description: "95th percentile validation duration is {{ $value }}s for {{ $labels.module_key }}"

      # License Expiration Alerts
      - alert: LicenseExpiringCritical
        expr: |
          license_expiring_count{days_until_expiration="7"} > 0
        for: 1m
        labels:
          severity: critical
          component: license_expiration
        annotations:
          summary: "Licenses expiring within 7 days"
          description: "{{ $value }} license(s) for {{ $labels.module_key }} expiring within 7 days"

      - alert: LicenseExpiringWarning
        expr: |
          license_expiring_count{days_until_expiration="30"} > 0
        for: 1m
        labels:
          severity: warning
          component: license_expiration
        annotations:
          summary: "Licenses expiring within 30 days"
          description: "{{ $value }} license(s) for {{ $labels.module_key }} expiring within 30 days"

      - alert: LicenseExpired
        expr: |
          license_expired_count > 0
        for: 1m
        labels:
          severity: critical
          component: license_expiration
        annotations:
          summary: "Expired licenses detected"
          description: "{{ $value }} expired license(s) detected for {{ $labels.module_key }}"

      # Usage Limit Alerts
      - alert: UsageLimitWarning
        expr: |
          usage_limit_percentage >= 80 and usage_limit_percentage < 95
        for: 5m
        labels:
          severity: warning
          component: usage_limits
        annotations:
          summary: "Usage approaching limit"
          description: "{{ $labels.module_key }} {{ $labels.limit_type }} usage at {{ $value }}% for tenant {{ $labels.tenant_id }}"

      - alert: UsageLimitCritical
        expr: |
          usage_limit_percentage >= 95
        for: 1m
        labels:
          severity: critical
          component: usage_limits
        annotations:
          summary: "Usage critically high"
          description: "{{ $labels.module_key }} {{ $labels.limit_type }} usage at {{ $value }}% for tenant {{ $labels.tenant_id }}"

      - alert: UsageLimitExceeded
        expr: |
          rate(usage_limit_exceeded_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          component: usage_limits
        annotations:
          summary: "Usage limit exceeded"
          description: "{{ $labels.module_key }} {{ $labels.limit_type }} limit exceeded for tenant {{ $labels.tenant_id }}"

      # Cache Performance Alerts
      - alert: LowCacheHitRate
        expr: |
          (
            rate(license_cache_hits_total[5m]) 
            / 
            (rate(license_cache_hits_total[5m]) + rate(license_cache_misses_total[5m]))
          ) < 0.5
        for: 10m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "Low license validation cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for {{ $labels.cache_type }}"

      # Audit Log Alerts
      - alert: HighViolationRate
        expr: |
          rate(audit_log_entries_total{severity="critical"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: audit
        annotations:
          summary: "High rate of critical audit events"
          description: "Critical audit events occurring at {{ $value }} per second"

      # Module Activity Alerts
      - alert: UnexpectedModuleDeactivations
        expr: |
          rate(module_deactivations_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: module_management
        annotations:
          summary: "High rate of module deactivations"
          description: "Modules being deactivated at {{ $value }} per second for {{ $labels.module_key }}"
