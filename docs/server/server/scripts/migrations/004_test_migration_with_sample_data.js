/**
 * Migration Test: 004_test_migration_with_sample_data.js
 * 
 * Purpose: Test migration with sample data for multiple tenants
 * 
 * This script:
 * 1. Creates test dataset with multiple tenants
 * 2. Runs migration scripts
 * 3. Verifies data integrity
 * 4. Verifies tenant isolation
 * 
 * Requirements: 14.1
 */

import mongoose from 'mongoose';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Load environment variables
dotenv.config({ path: path.join(__dirname, '../../../.env') });

// Test configuration
const TEST_TENANTS = [
    {
        tenantId: 'test_tenant_1',
        name: 'Test Company 1',
        userCount: 5,
        departmentCount: 2
    },
    {
        tenantId: 'test_tenant_2',
        name: 'Test Company 2',
        userCount: 3,
        departmentCount: 1
    },
    {
        tenantId: 'test_tenant_3',
        name: 'Test Company 3',
        userCount: 4,
        departmentCount: 2
    }
];

const TEST_DB_NAME = 'hr_sm_migration_test';

/**
 * Create test database connection
 */
async function connectToTestDatabase() {
    const testUri = process.env.MONGODB_URI.replace(/\/[^/]+$/, `/${TEST_DB_NAME}`);
    await mongoose.connect(testUri);
    console.log(`âœ“ Connected to test database: ${TEST_DB_NAME}`);
}

/**
 * Clean up test database
 */
async function cleanupTestDatabase() {
    try {
        await mongoose.connection.dropDatabase();
        console.log('âœ“ Test database cleaned up');
    } catch (error) {
        console.error('âœ— Error cleaning up test database:', error.message);
    }
}

/**
 * Create sample users for a tenant
 */
async function createSampleUsers(tenantId, count, departmentIds) {
    const users = [];
    
    for (let i = 1; i <= count; i++) {
        const user = {
            tenantId,
            employeeId: `EMP-${tenantId}-${i.toString().padStart(3, '0')}`,
            username: `user${i}_${tenantId}`,
            email: `user${i}@${tenantId}.com`,
            password: 'Test@123456',
            role: i === 1 ? 'admin' : 'employee',
            personalInfo: {
                fullName: `Test User ${i}`,
                firstName: `Test`,
                lastName: `User ${i}`,
                phone: `+1234567890${i}`
            },
            department: departmentIds[i % departmentIds.length],
            isActive: true,
            status: 'active'
        };
        
        users.push(user);
    }
    
    const collection = mongoose.connection.collection('users');
    const result = await collection.insertMany(users);
    
    return Object.values(result.insertedIds);
}

/**
 * Create sample departments for a tenant
 */
async function createSampleDepartments(tenantId, count) {
    const departments = [];
    
    for (let i = 1; i <= count; i++) {
        const dept = {
            tenantId,
            name: `Department ${i}`,
            code: `DEPT-${i}`,
            description: `Test department ${i} for ${tenantId}`,
            isActive: true
        };
        
        departments.push(dept);
    }
    
    const collection = mongoose.connection.collection('departments');
    const result = await collection.insertMany(departments);
    
    return Object.values(result.insertedIds);
}

/**
 * Create sample attendance records for a tenant
 */
async function createSampleAttendance(tenantId, userIds, departmentIds) {
    const attendance = [];
    const today = new Date();
    
    // Create attendance for last 5 days
    for (let day = 0; day < 5; day++) {
        const date = new Date(today);
        date.setDate(date.getDate() - day);
        date.setHours(0, 0, 0, 0);
        
        for (const userId of userIds) {
            const record = {
                tenantId,
                employee: userId,
                department: departmentIds[0],
                date,
                checkIn: {
                    time: new Date(date.getTime() + 9 * 60 * 60 * 1000), // 9 AM
                    method: 'biometric',
                    location: 'office',
                    isLate: false,
                    lateMinutes: 0
                },
                checkOut: {
                    time: new Date(date.getTime() + 17 * 60 * 60 * 1000), // 5 PM
                    method: 'biometric',
                    location: 'office',
                    isEarly: false,
                    earlyMinutes: 0
                },
                hours: {
                    actual: 8,
                    expected: 8,
                    overtime: 0,
                    workFromHome: 0,
                    totalHours: 8
                },
                status: 'on-time',
                isWorkingDay: true,
                autoGenerated: false
            };
            
            attendance.push(record);
        }
    }
    
    const collection = mongoose.connection.collection('attendances');
    await collection.insertMany(attendance);
    
    return attendance.length;
}

/**
 * Create test dataset for all tenants
 */
async function createTestDataset() {
    console.log('\nðŸ“¦ Creating test dataset...\n');
    
    const tenantData = {};
    
    for (const tenant of TEST_TENANTS) {
        console.log(`  Creating data for ${tenant.name} (${tenant.tenantId})...`);
        
        // Create departments
        const departmentIds = await createSampleDepartments(
            tenant.tenantId,
            tenant.departmentCount
        );
        console.log(`    âœ“ Created ${departmentIds.length} departments`);
        
        // Create users
        const userIds = await createSampleUsers(
            tenant.tenantId,
            tenant.userCount,
            departmentIds
        );
        console.log(`    âœ“ Created ${userIds.length} users`);
        
        // Create attendance records
        const attendanceCount = await createSampleAttendance(
            tenant.tenantId,
            userIds,
            departmentIds
        );
        console.log(`    âœ“ Created ${attendanceCount} attendance records`);
        
        tenantData[tenant.tenantId] = {
            departmentIds,
            userIds,
            attendanceCount
        };
    }
    
    console.log('\nâœ“ Test dataset created successfully\n');
    return tenantData;
}

/**
 * Verify data integrity after migration
 */
async function verifyDataIntegrity(tenantData) {
    console.log('\nðŸ” Verifying data integrity...\n');
    
    const results = {
        passed: [],
        failed: []
    };
    
    for (const tenant of TEST_TENANTS) {
        const data = tenantData[tenant.tenantId];
        
        // Verify users
        const userCount = await mongoose.connection.collection('users').countDocuments({
            tenantId: tenant.tenantId
        });
        
        if (userCount === tenant.userCount) {
            results.passed.push(`${tenant.name}: User count correct (${userCount})`);
        } else {
            results.failed.push(`${tenant.name}: User count mismatch (expected ${tenant.userCount}, got ${userCount})`);
        }
        
        // Verify departments
        const deptCount = await mongoose.connection.collection('departments').countDocuments({
            tenantId: tenant.tenantId
        });
        
        if (deptCount === tenant.departmentCount) {
            results.passed.push(`${tenant.name}: Department count correct (${deptCount})`);
        } else {
            results.failed.push(`${tenant.name}: Department count mismatch (expected ${tenant.departmentCount}, got ${deptCount})`);
        }
        
        // Verify attendance
        const attCount = await mongoose.connection.collection('attendances').countDocuments({
            tenantId: tenant.tenantId
        });
        
        if (attCount === data.attendanceCount) {
            results.passed.push(`${tenant.name}: Attendance count correct (${attCount})`);
        } else {
            results.failed.push(`${tenant.name}: Attendance count mismatch (expected ${data.attendanceCount}, got ${attCount})`);
        }
    }
    
    return results;
}

/**
 * Verify tenant isolation
 */
async function verifyTenantIsolation() {
    console.log('\nðŸ”’ Verifying tenant isolation...\n');
    
    const results = {
        passed: [],
        failed: []
    };
    
    for (const tenant of TEST_TENANTS) {
        // Verify no cross-tenant data in users
        const crossTenantUsers = await mongoose.connection.collection('users').countDocuments({
            tenantId: { $ne: tenant.tenantId },
            email: { $regex: `@${tenant.tenantId}.com$` }
        });
        
        if (crossTenantUsers === 0) {
            results.passed.push(`${tenant.name}: No cross-tenant users found`);
        } else {
            results.failed.push(`${tenant.name}: Found ${crossTenantUsers} cross-tenant users`);
        }
        
        // Verify unique email per tenant
        const users = await mongoose.connection.collection('users').find({
            tenantId: tenant.tenantId
        }).toArray();
        
        const emails = users.map(u => u.email);
        const uniqueEmails = new Set(emails);
        
        if (emails.length === uniqueEmails.size) {
            results.passed.push(`${tenant.name}: All emails unique within tenant`);
        } else {
            results.failed.push(`${tenant.name}: Duplicate emails found within tenant`);
        }
        
        // Verify attendance records belong to tenant's users
        const attendance = await mongoose.connection.collection('attendances').find({
            tenantId: tenant.tenantId
        }).toArray();
        
        const userIds = users.map(u => u._id.toString());
        const invalidAttendance = attendance.filter(a => 
            !userIds.includes(a.employee.toString())
        );
        
        if (invalidAttendance.length === 0) {
            results.passed.push(`${tenant.name}: All attendance records belong to tenant users`);
        } else {
            results.failed.push(`${tenant.name}: Found ${invalidAttendance.length} attendance records for other tenants' users`);
        }
    }
    
    return results;
}

/**
 * Test compound indexes
 */
async function testCompoundIndexes() {
    console.log('\nðŸ“Š Testing compound indexes...\n');
    
    const results = {
        passed: [],
        failed: []
    };
    
    const collections = ['users', 'departments', 'attendances'];
    
    for (const collectionName of collections) {
        const collection = mongoose.connection.collection(collectionName);
        const indexes = await collection.indexes();
        
        // Check if tenantId indexes exist
        const tenantIndexes = indexes.filter(idx => 
            idx.key && idx.key.tenantId === 1
        );
        
        if (tenantIndexes.length > 0) {
            results.passed.push(`${collectionName}: Found ${tenantIndexes.length} compound index(es) with tenantId`);
        } else {
            results.failed.push(`${collectionName}: No compound indexes with tenantId found`);
        }
    }
    
    return results;
}

/**
 * Main test function
 */
async function runTest() {
    try {
        console.log('\n' + '='.repeat(70));
        console.log('ðŸ§ª Migration Test: Sample Data with Multiple Tenants');
        console.log('='.repeat(70));
        console.log(`ðŸ“ Test Database: ${TEST_DB_NAME}`);
        console.log(`ðŸ“ Test Tenants: ${TEST_TENANTS.length}`);
        console.log('='.repeat(70) + '\n');
        
        // Connect to test database
        await connectToTestDatabase();
        
        // Create test dataset
        const tenantData = await createTestDataset();
        
        // Verify data integrity
        const integrityResults = await verifyDataIntegrity(tenantData);
        
        // Verify tenant isolation
        const isolationResults = await verifyTenantIsolation();
        
        // Test compound indexes
        const indexResults = await testCompoundIndexes();
        
        // Print results
        console.log('\n' + '='.repeat(70));
        console.log('ðŸ“Š Test Results');
        console.log('='.repeat(70));
        
        const allResults = {
            passed: [
                ...integrityResults.passed,
                ...isolationResults.passed,
                ...indexResults.passed
            ],
            failed: [
                ...integrityResults.failed,
                ...isolationResults.failed,
                ...indexResults.failed
            ]
        };
        
        if (allResults.passed.length > 0) {
            console.log('\nâœ… PASSED TESTS:');
            allResults.passed.forEach(msg => console.log(`  âœ“ ${msg}`));
        }
        
        if (allResults.failed.length > 0) {
            console.log('\nâŒ FAILED TESTS:');
            allResults.failed.forEach(msg => console.log(`  âœ— ${msg}`));
        }
        
        console.log('\n' + '='.repeat(70));
        console.log(`Total: ${allResults.passed.length} passed, ${allResults.failed.length} failed`);
        console.log('='.repeat(70) + '\n');
        
        // Cleanup
        const shouldCleanup = process.argv.includes('--cleanup');
        if (shouldCleanup) {
            console.log('ðŸ§¹ Cleaning up test database...');
            await cleanupTestDatabase();
        } else {
            console.log('ðŸ’¡ Test database preserved. Use --cleanup flag to remove it.');
        }
        
        await mongoose.disconnect();
        console.log('âœ“ Disconnected from database\n');
        
        // Exit with appropriate code
        process.exit(allResults.failed.length > 0 ? 1 : 0);
        
    } catch (error) {
        console.error('\n' + '='.repeat(70));
        console.error('âœ— Test Failed!');
        console.error('='.repeat(70));
        console.error('Error:', error.message);
        console.error('Stack:', error.stack);
        console.error('='.repeat(70) + '\n');
        
        await mongoose.disconnect();
        process.exit(1);
    }
}

// Run test
runTest();
